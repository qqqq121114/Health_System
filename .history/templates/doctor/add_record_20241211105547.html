{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>添加健康记录</h2>
            <a href="{{ url_for('doctor_dashboard') }}" class="btn btn-secondary">返回工作台</a>
        </div>
        <hr>
    </div>
</div>

<!-- 显示提示消息 -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <form id="addRecordForm" action="{{ url_for('doctor_add_record') }}" method="POST">
                    <!-- 患者信息 -->
                    <div class="form-section">
                        <h6 class="mb-3">患者信息</h6>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label required-field">患者用户名</label>
                                <input type="text" class="form-control" name="patient_username" required
                                    placeholder="请输入患者的用户名">
                                <div class="form-text">请确保输入正确的患者用户名</div>
                            </div>
                        </div>
                    </div>

                    <!-- 基本信息 -->
                    <div class="form-section">
                        <h6 class="mb-3">基本信息</h6>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label required-field">记录类型</label>
                                <select class="form-select" name="record_type" id="recordType" required>
                                    <option value="">请选择记录类型</option>
                                    <option value="体检报告">体检报告</option>
                                    <option value="病���记录">病史记录</option>
                                    <option value="日常监测">日常监测</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label required-field">记录日期</label>
                                <input type="date" class="form-control" name="record_date" required>
                            </div>
                        </div>
                    </div>

                    <!-- 动态表单区域 -->
                    <!-- 日常监测表单 -->
                    <div id="dailyMonitoringForm" class="form-section" style="display: none;">
                        <h6 class="mb-3">体征数据</h6>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">血压(收缩压/mmHg)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="blood_pressure_sys" 
                                        min="60" max="250" step="1" placeholder="90-140">
                                </div>
                                <div class="form-text">正常范围：90-140</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">血压(舒张压/mmHg)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="blood_pressure_dia"
                                        min="40" max="150" step="1" placeholder="60-90">
                                </div>
                                <div class="form-text">正常范围：60-90</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">心率(次/分)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="heart_rate"
                                        min="40" max="180" step="1" placeholder="60-100">
                                </div>
                                <div class="form-text">正常范围：60-100</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">体温(℃)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="body_temperature"
                                        min="35" max="42" step="0.1" placeholder="36.3-37.2">
                                </div>
                                <div class="form-text">正常范围：36.3-37.2</div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">血糖(mmol/L)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="blood_sugar"
                                        min="2" max="30" step="0.1" placeholder="3.9-6.1">
                                </div>
                                <div class="form-text">空腹正常范围：3.9-6.1</div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" name="description" maxlength="500" 
                                    placeholder="请输入备注信息（最多500字）"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 体检报告表单 -->
                    <div id="physicalExamForm" class="form-section" style="display: none;">
                        <h6 class="mb-3">体格检查</h6>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">身高(cm)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="height"
                                        min="100" max="250" step="0.1" placeholder="150-200">
                                </div>
                                <div class="form-text">请输入实际身高</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">体重(kg)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="weight"
                                        min="20" max="200" step="0.1" placeholder="40-150">
                                </div>
                                <div class="form-text">请输入实际体重</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">血压(收缩压/mmHg)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="blood_pressure_sys"
                                        min="60" max="250" step="1" placeholder="90-140">
                                </div>
                                <div class="form-text">正常范围：90-140</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">血压(舒张压/mmHg)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="blood_pressure_dia"
                                        min="40" max="150" step="1" placeholder="60-90">
                                </div>
                                <div class="form-text">正常范围：60-90</div>
                            </div>
                        </div>

                        <h6 class="mb-3">实验室检查</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">血常规</label>
                                <textarea class="form-control" name="blood_routine" maxlength="1000"
                                    placeholder="请输入血常规检查结果，包括血红蛋白、白细胞、血小板等指标"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">尿常规</label>
                                <textarea class="form-control" name="urine_routine" maxlength="1000"
                                    placeholder="请输入尿常规检查结果，包括尿蛋白、尿糖、尿潜血等指标"></textarea>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">肝功能</label>
                                <textarea class="form-control" name="liver_function" maxlength="1000"
                                    placeholder="请输入肝功能检��结果，包括转氨酶、胆红素等指标"></textarea>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">肾功能</label>
                                <textarea class="form-control" name="kidney_function" maxlength="1000"
                                    placeholder="请输入肾功能检查结果，包括肌酐、尿素氮等指标"></textarea>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">血脂</label>
                                <textarea class="form-control" name="blood_lipids" maxlength="1000"
                                    placeholder="请输入血脂检查结果，包括总胆固醇、甘油三酯等指标"></textarea>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">其他检查结果</label>
                                <textarea class="form-control" name="description" maxlength="1000"
                                    placeholder="请输入其他检查结果和说明"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 病史记录表单 -->
                    <div id="medicalHistoryForm" class="form-section" style="display: none;">
                        <h6 class="mb-3">病情信息</h6>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label required-field">症状描述</label>
                                <textarea class="form-control" name="symptoms" maxlength="1000" required
                                    placeholder="请详细描述症状，包括发生时间、持续时间、症状特点等"></textarea>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label required-field">诊断结果</label>
                                <textarea class="form-control" name="diagnosis" maxlength="1000" required
                                    placeholder="请输入医生的诊断结果"></textarea>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label required-field">治疗方案</label>
                                <textarea class="form-control" name="treatment" maxlength="1000" required
                                    placeholder="请详细描述治疗方案，包括治疗方法、注意事项等"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required-field">用药情况</label>
                                <textarea class="form-control" name="medications" maxlength="1000" required
                                    placeholder="请详细记录用药信息，包括药品名称、用量、用法等"></textarea>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">备注说明</label>
                                <textarea class="form-control" name="description" maxlength="500"
                                    placeholder="其他需要说明的情况（最多500字）"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">保存记录</button>
                                <a href="{{ url_for('doctor_dashboard') }}" class="btn btn-secondary">取消</a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* 数字输入框统一宽度 */
.form-control[type="number"] {
    width: 150px !important;
}

/* 文本框统一高度 */
.form-control[type="text"],
.form-control[type="number"],
.form-select {
    height: 38px !important;
}

/* 文本域统一高度 */
textarea.form-control {
    height: 80px !important;
    resize: none;
}

/* 输入框组样式 */
.input-group {
    margin-bottom: 15px;
}

/* 标签样式 */
.form-label {
    font-weight: 500;
    margin-bottom: 5px;
}

/* 提示文本样式 */
.form-text {
    font-size: 12px;
    color: #6c757d;
    margin-top: 4px;
}

/* 表单分组样式 */
.form-section {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

/* 必填字段标记 */
.required-field::after {
    content: "*";
    color: red;
    margin-left: 4px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化日期选择器为当前日期
    document.querySelector('input[type="date"]').valueAsDate = new Date();

    // 监听记录类型选择变化
    const recordTypeSelect = document.getElementById('recordType');
    const dailyMonitoringForm = document.getElementById('dailyMonitoringForm');
    const physicalExamForm = document.getElementById('physicalExamForm');
    const medicalHistoryForm = document.getElementById('medicalHistoryForm');

    recordTypeSelect.addEventListener('change', function() {
        // 隐藏所有表单
        dailyMonitoringForm.style.display = 'none';
        physicalExamForm.style.display = 'none';
        medicalHistoryForm.style.display = 'none';

        // 显示选中的表单
        switch(this.value) {
            case '日常监测':
                dailyMonitoringForm.style.display = 'block';
                break;
            case '体检报告':
                physicalExamForm.style.display = 'block';
                break;
            case '病史记录':
                medicalHistoryForm.style.display = 'block';
                break;
        }
    });

    // 表单验证
    const form = document.getElementById('addRecordForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // 验证患者用户名
        const patientUsername = form.querySelector('input[name="patient_username"]').value;
        if (!patientUsername) {
            alert('请输入患者用户名');
            return;
        }

        // 验证记录类型
        const recordType = recordTypeSelect.value;
        if (!recordType) {
            alert('请选择记录类型');
            return;
        }

        // 根据记录类型验证必填字段
        if (recordType === '病史记录') {
            const requiredFields = ['symptoms', 'diagnosis', 'treatment', 'medications'];
            for (const field of requiredFields) {
                const input = form.querySelector(`[name="${field}"]`);
                if (!input.value.trim()) {
                    alert('请填写所有必填字段');
                    return;
                }
            }
        }

        // 提交表单
        form.submit();
    });

    // 为所有数字输入框添加输入验证
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', function() {
            const value = parseFloat(this.value);
            const min = parseFloat(this.min);
            const max = parseFloat(this.max);
            
            if (value < min) this.value = min;
            if (value > max) this.value = max;
        });
    });

    // 为所有文本域添加字数统计
    document.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('input', function() {
            const maxLength = this.getAttribute('maxlength');
            const currentLength = this.value.length;
            const remainingChars = maxLength - currentLength;
            
            // 更新或创建字数提示
            let counter = this.nextElementSibling;
            if (!counter || !counter.classList.contains('char-counter')) {
                counter = document.createElement('div');
                counter.classList.add('char-counter', 'form-text');
                this.parentNode.insertBefore(counter, this.nextSibling);
            }
            counter.textContent = `还可输入 ${remainingChars} 字`;
        });
    });
});
</script>
{% endblock %} 