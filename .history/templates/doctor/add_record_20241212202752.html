{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title mb-4">添加健康记录</h3>
                    <form method="POST" action="{{ url_for('doctor_add_record') }}" id="recordForm">
                        <!-- 患者信息 -->
                        <div class="mb-4">
                            <h5>患者信息</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">患者用户账号</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="patient_username" id="patientUsername" 
                                                   value="{{ patient.username if patient else '' }}" required>
                                            <button class="btn btn-outline-secondary" type="button" id="checkPatient">
                                                <i class="fas fa-search"></i> 查找
                                            </button>
                                        </div>
                                        <div class="form-text">请输入患者的用户账号</div>
                                        <div id="patientCheckResult" class="mt-2"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">患者姓名</label>
                                        <input type="text" class="form-control" id="patientName" 
                                               value="{{ patient.name if patient else '' }}" readonly>
                                        <div class="form-text">用户账号验证后自动填充</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 基本信息 -->
                        <div class="mb-4">
                            <h5>基本信息</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">记录类型</label>
                                        <select class="form-select" name="record_type" id="recordType" required>
                                            <option value="">请选择记录类型</option>
                                            <option value="MEDICAL_HISTORY">病史记录</option>
                                            <option value="PHYSICAL_EXAM">体检报告</option>
                                            <option value="DAILY_MONITOR">日常监测</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">记录日期</label>
                                        <input type="date" class="form-control" name="record_date" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 病史记录表单 -->
                        <div id="medicalHistoryForm" class="record-form" style="display: none;">
                            <!-- 主诉 -->
                            <div class="mb-4">
                                <h5>主诉</h5>
                                <div class="mb-3">
                                    <label class="form-label">主要症状</label>
                                    <textarea class="form-control" name="symptoms" rows="3" 
                                            placeholder="请详细描述患者的主要症状、持续时间等"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">发病时间</label>
                                            <input type="date" class="form-control" name="onset_date">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">症状程度</label>
                                            <select class="form-select" name="severity">
                                                <option value="轻度">轻度</option>
                                                <option value="中度">中度</option>
                                                <option value="重度">重度</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 现病史 -->
                            <div class="mb-4">
                                <h5>现病史</h5>
                                <div class="mb-3">
                                    <label class="form-label">病情发展经过</label>
                                    <textarea class="form-control" name="illness_history" rows="3"
                                            placeholder="请描述疾病的发展过程、治疗经过等"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">治疗情况</label>
                                    <textarea class="form-control" name="treatment_history" rows="2"
                                            placeholder="请描述已经采取的治疗措施及效果"></textarea>
                                </div>
                            </div>

                            <!-- 既往史 -->
                            <div class="mb-4">
                                <h5>既往史</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">疾病史</label>
                                            <textarea class="form-control" name="disease_history" rows="2"
                                                    placeholder="既往疾病、手术、外伤等"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">过敏史</label>
                                            <textarea class="form-control" name="allergy_history" rows="2"
                                                    placeholder="药物或其他过敏情况"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">家族病史</label>
                                    <textarea class="form-control" name="family_history" rows="2"
                                            placeholder="家族遗传病史或相关疾病史"></textarea>
                                </div>
                            </div>

                            <!-- 体格检查 -->
                            <div class="mb-4">
                                <h5>体格检查</h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">体温 (℃)</label>
                                            <input type="number" class="form-control" name="temperature" 
                                                   step="0.1" min="35" max="42">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">脉搏 (次/分)</label>
                                            <input type="number" class="form-control" name="pulse" 
                                                   min="40" max="200">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">收缩压 (mmHg)</label>
                                            <input type="number" class="form-control" name="blood_pressure_sys" 
                                                   min="60" max="250">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">舒张压 (mmHg)</label>
                                            <input type="number" class="form-control" name="blood_pressure_dia" 
                                                   min="40" max="150">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">体格检查记录</label>
                                    <textarea class="form-control" name="physical_examination" rows="3"
                                            placeholder="请记录体格检查的具体发现"></textarea>
                                </div>
                            </div>

                            <!-- 诊断和治疗计划 -->
                            <div class="mb-4">
                                <h5>诊断与治疗</h5>
                                <div class="mb-3">
                                    <label class="form-label">初步诊断</label>
                                    <textarea class="form-control" name="diagnosis" rows="2"
                                            placeholder="请填写诊断结果"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">治疗方案</label>
                                    <textarea class="form-control" name="treatment" rows="3"
                                            placeholder="请详细描述治疗方案"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">用药建议</label>
                                    <textarea class="form-control" name="medications" rows="3"
                                            placeholder="请填写具体用药建议，包括药品名称、用量、用法等"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">注意事项</label>
                                    <textarea class="form-control" name="precautions" rows="2"
                                            placeholder="需要特别注意的事项"></textarea>
                                </div>
                            </div>

                            <!-- 随访计划 -->
                            <div class="mb-4">
                                <h5>随访计划</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">建议复诊日期</label>
                                            <input type="date" class="form-control" name="follow_up_date">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">复诊项目</label>
                                            <input type="text" class="form-control" name="follow_up_items"
                                                   placeholder="需要复查的项目">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 体检报告表单 -->
                        <div id="physicalExamForm" class="record-form" style="display: none;">
                            <!-- 基础体格检查 -->
                            <div class="mb-4">
                                <h5>基础体格检查</h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">身高 (cm)</label>
                                            <input type="number" class="form-control" name="height" 
                                                   step="0.1" min="100" max="250">
                                            <div class="form-text">正常范围：100-250</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">体重 (kg)</label>
                                            <input type="number" class="form-control" name="weight" 
                                                   step="0.1" min="20" max="200">
                                            <div class="form-text">正常范围：20-200</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">BMI</label>
                                            <input type="number" class="form-control" name="bmi" readonly>
                                            <div class="form-text">自动计算</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">体温 (℃)</label>
                                            <input type="number" class="form-control" name="temperature" 
                                                   step="0.1" min="35" max="42">
                                            <div class="form-text">正常范围：35-42</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 生命体征 -->
                            <div class="mb-4">
                                <h5>生命体征</h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">心率 (次/分)</label>
                                            <input type="number" class="form-control" name="heart_rate" 
                                                   min="40" max="200">
                                            <div class="form-text">正常范围：40-200</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">收缩压 (mmHg)</label>
                                            <input type="number" class="form-control" name="blood_pressure_sys" 
                                                   min="60" max="250">
                                            <div class="form-text">正常范围：60-250</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">舒张压 (mmHg)</label>
                                            <input type="number" class="form-control" name="blood_pressure_dia" 
                                                   min="40" max="150">
                                            <div class="form-text">正常范围：40-150</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">血氧饱和度 (%)</label>
                                            <input type="number" class="form-control" name="oxygen_saturation" 
                                                   step="0.1" min="80" max="100">
                                            <div class="form-text">正常范围：80-100</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 血液检查 -->
                            <div class="mb-4">
                                <h5>血液检查</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">血糖 (mmol/L)</label>
                                            <input type="number" class="form-control" name="blood_sugar" 
                                                   step="0.1" min="2" max="30">
                                            <div class="form-text">正常范围：2-30</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">血脂</label>
                                            <textarea class="form-control" name="blood_fat" rows="2"
                                                    placeholder="请填写血脂检查结果"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 器官功能 -->
                            <div class="mb-4">
                                <h5>器官功能</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">肝功能</label>
                                            <textarea class="form-control" name="liver_function" rows="2"
                                                    placeholder="请填写肝功能检查结果"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">肾功能</label>
                                            <textarea class="form-control" name="kidney_function" rows="2"
                                                    placeholder="请填写肾功能检查结果"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 日常监测表单 -->
                        <div id="dailyMonitorForm" class="record-form" style="display: none;">
                            <!-- 基本体征 -->
                            <div class="mb-4">
                                <h5>基本体征</h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">体温 (℃)</label>
                                            <input type="number" class="form-control" name="temperature" 
                                                   step="0.1" min="35" max="42">
                                            <div class="form-text">正常范围：35-42</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">脉搏 (次/分)</label>
                                            <input type="number" class="form-control" name="pulse" 
                                                   min="40" max="200">
                                            <div class="form-text">正常范围：40-200</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">呼吸频率 (次/分)</label>
                                            <input type="number" class="form-control" name="respiratory_rate" 
                                                   min="10" max="40">
                                            <div class="form-text">正常范围：10-40</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">血氧饱和度 (%)</label>
                                            <input type="number" class="form-control" name="oxygen_saturation" 
                                                   step="0.1" min="80" max="100">
                                            <div class="form-text">正常范围：80-100</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 血压测量 -->
                            <div class="mb-4">
                                <h5>血压测量</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">收缩压 (mmHg)</label>
                                            <input type="number" class="form-control" name="blood_pressure_sys" 
                                                   min="60" max="250">
                                            <div class="form-text">正常范围：60-250</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">舒张压 (mmHg)</label>
                                            <input type="number" class="form-control" name="blood_pressure_dia" 
                                                   min="40" max="150">
                                            <div class="form-text">正常范围：40-150</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 血糖监测 -->
                            <div class="mb-4">
                                <h5>血糖监测</h5>
                                <div class="mb-3">
                                    <label class="form-label">血糖值 (mmol/L)</label>
                                    <input type="number" class="form-control" name="blood_sugar" 
                                           step="0.1" min="2" max="30">
                                    <div class="form-text">正常范围：2-30</div>
                                </div>
                            </div>
                        </div>

                        <!-- 提交按钮 -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 保存记录
                            </button>
                            <a href="{{ url_for('doctor_patient_list') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> 取消
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 表单切换脚本 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 设置当前日期为默认日期
    const today = new Date();
    const dateInput = document.querySelector('input[name="record_date"]');
    dateInput.valueAsDate = today;
    
    const recordType = document.getElementById('recordType');
    const forms = {
        'MEDICAL_HISTORY': document.getElementById('medicalHistoryForm'),
        'PHYSICAL_EXAM': document.getElementById('physicalExamForm'),
        'DAILY_MONITOR': document.getElementById('dailyMonitorForm')
    };

    // 表单切换
    recordType.addEventListener('change', function() {
        // 隐藏所有表单
        Object.values(forms).forEach(form => {
            if (form) form.style.display = 'none';
        });

        // 显示选中的表单
        const selectedForm = forms[this.value];
        if (selectedForm) {
            selectedForm.style.display = 'block';
        }
    });

    // BMI 自动计算
    const heightInput = document.querySelector('input[name="height"]');
    const weightInput = document.querySelector('input[name="weight"]');
    const bmiInput = document.querySelector('input[name="bmi"]');

    function calculateBMI() {
        if (heightInput.value && weightInput.value) {
            const height = heightInput.value / 100; // 转换为米
            const weight = weightInput.value;
            const bmi = (weight / (height * height)).toFixed(1);
            bmiInput.value = bmi;
        }
    }

    heightInput?.addEventListener('input', calculateBMI);
    weightInput?.addEventListener('input', calculateBMI);

    // 患者查找功能
    const checkPatientBtn = document.getElementById('checkPatient');
    const patientUsername = document.getElementById('patientUsername');
    const patientName = document.getElementById('patientName');
    const patientCheckResult = document.getElementById('patientCheckResult');

    checkPatientBtn?.addEventListener('click', function() {
        const username = patientUsername.value;
        if (!username) {
            patientCheckResult.innerHTML = '<div class="alert alert-warning">请输入患者用户账号</div>';
            return;
        }

        // 发送 AJAX 请求查找患者
        fetch(`/api/check_patient/${username}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    patientName.value = data.patient.name;
                    patientCheckResult.innerHTML = '<div class="alert alert-success">找到患者</div>';
                } else {
                    patientName.value = '';
                    patientCheckResult.innerHTML = '<div class="alert alert-danger">未找到患者</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                patientCheckResult.innerHTML = '<div class="alert alert-danger">查找失败，请重试</div>';
            });
    });
});
</script>

<!-- 表单提交脚本 -->
<script>
document.getElementById('recordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{{ url_for("doctor_add_record") }}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 显示成功消息
            alert('记录添加成功！');
            // 跳转到医生主页
            window.location.href = '{{ url_for("doctor_home") }}';
        } else {
            alert('添加记录失败：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('添加记录失败，请重试');
    });
});
</script>
{% endblock %} 