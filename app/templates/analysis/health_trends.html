{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2>健康趋势分析</h2>
            <hr>
        </div>
    </div>

    {% if not dates %}
    <div class="row">
        <div class="col-md-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 暂无健康记录数据，请先添加健康记录。
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <!-- 血压趋势图 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">血压趋势</h5>
                    <canvas id="bloodPressureChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 血糖趋势图 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">血糖趋势</h5>
                    <canvas id="bloodSugarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 心率趋势图 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">心率趋势</h5>
                    <canvas id="heartRateChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 体重趋势图 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">体重趋势</h5>
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script>
// 日期数据
const dates = {{ dates|tojson }};

// 血压趋势图
const bloodPressureData = {{ blood_pressure|tojson }};
const systolicData = [];
const diastolicData = [];

bloodPressureData.forEach(bp => {
    if (bp) {
        const [sys, dia] = bp.split('/').map(Number);
        systolicData.push(sys);
        diastolicData.push(dia);
    } else {
        systolicData.push(null);
        diastolicData.push(null);
    }
});

new Chart(document.getElementById('bloodPressureChart'), {
    type: 'line',
    data: {
        labels: dates,
        datasets: [{
            label: '收缩压',
            data: systolicData,
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            tension: 0.1,
            fill: true
        }, {
            label: '舒张压',
            data: diastolicData,
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '血压变化趋势 (mmHg)'
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                title: {
                    display: true,
                    text: 'mmHg'
                }
            },
            x: {
                title: {
                    display: true,
                    text: '日期'
                }
            }
        }
    }
});

// 血糖趋势图
new Chart(document.getElementById('bloodSugarChart'), {
    type: 'line',
    data: {
        labels: dates,
        datasets: [{
            label: '血糖',
            data: {{ blood_sugar|tojson }},
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '血糖变化趋势 (mmol/L)'
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                title: {
                    display: true,
                    text: 'mmol/L'
                }
            },
            x: {
                title: {
                    display: true,
                    text: '日期'
                }
            }
        }
    }
});

// 心率趋势图
new Chart(document.getElementById('heartRateChart'), {
    type: 'line',
    data: {
        labels: dates,
        datasets: [{
            label: '心率',
            data: {{ heart_rate|tojson }},
            borderColor: 'rgb(153, 102, 255)',
            backgroundColor: 'rgba(153, 102, 255, 0.1)',
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '心率变化趋势 (次/分)'
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                title: {
                    display: true,
                    text: '次/分'
                }
            },
            x: {
                title: {
                    display: true,
                    text: '日期'
                }
            }
        }
    }
});

// 体重趋势图
new Chart(document.getElementById('weightChart'), {
    type: 'line',
    data: {
        labels: dates,
        datasets: [{
            label: '体重',
            data: {{ weight|tojson }},
            borderColor: 'rgb(255, 159, 64)',
            backgroundColor: 'rgba(255, 159, 64, 0.1)',
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: '体重变化趋势 (kg)'
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                title: {
                    display: true,
                    text: 'kg'
                }
            },
            x: {
                title: {
                    display: true,
                    text: '日期'
                }
            }
        }
    }
});
</script>
{% endblock %} 